<!-- Generated from dbca41c on 2023-12-28 @ 00:36 with Emacs 27.2 (Org mode 9.4.4) -->
<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta author="System Crafters - David Wilson"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="icon" type="image/png" href="/img/favicon.png"/><link rel="alternative" type="application/rss+xml" title="System Crafters News" href="https://weavermarquez.github.io/rss/news.xml"/><link rel="stylesheet" href="https://weavermarquez.github.io/fonts/iosevka-aile/iosevka-aile.css"/><link rel="stylesheet" href="https://weavermarquez.github.io/fonts/jetbrains-mono/jetbrains-mono.css"/><link rel="stylesheet" href="https://weavermarquez.github.io/css/code.css"/><link rel="stylesheet" href="https://weavermarquez.github.io/css/site.css"/><script defer="defer" data-domain="weavermarquez.github.io" src="https://plausible.io/js/plausible.js"></script><title>Learn to Love the Terminal Modes - System Crafters</title></head><body><header class="site-header"><div class="container"><div class="site-title"><img class="logo" src="https://weavermarquez.github.io/img/sc_logo.png" alt="System Crafters"/></div></div><div class="site-masthead"><div class="container"><nav class="nav"><a class="nav-link" href="/">Home</a> <a class="nav-link" href="/guides/">Guides</a> <a class="nav-link" href="/news/">News</a> <a class="nav-link" href="/community/">Community</a> <a class="nav-link" href="/">Home (2)</a> <a class="nav-link" href="/how-to-help/">How to Help</a></nav></div></div></header><div class="container"><div class="site-post"><h1 class="site-post-title">Learn to Love the Terminal Modes</h1><p class="site-post-meta"></p><div id="content"><ul class="org-ul">
<li><a href="https://youtu.be/wa_wZIuT9Vw">Watch the video</a> on YouTube!</li>
<li>Check out the <a href="https://github.com/daviwil/emacs-from-scratch/tree/bbfbc77b3afab0c14149e07d0ab08d275d4ba575">final code</a> on GitHub</li>
<li>Episode 9 of the <a href="../">Emacs From Scratch</a> series</li>
</ul>

<h2><a id="term-mode" class="anchor" href="#term-mode">¶</a>term-mode</h2><div class="outline-text-2" id="text-orgebc4cee">
<pre>(<span class="org-keyword">use-package</span> <span class="org-constant">term</span>
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> explicit-shell-file-name <span class="org-string">"bash"</span>)
  <span class="org-comment-delimiter">;;</span><span class="org-comment">(setq explicit-zsh-args '())</span>
  (<span class="org-keyword">setq</span> term-prompt-regexp <span class="org-string">"^[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">#$%&gt;\n]*[#$%&gt;] *"</span>))</pre>

<ul class="org-ul">
<li><code>C-c C-p</code> / <code>C-c C-n</code> - go back and forward in the buffer&rsquo;s prompts (also <code>[[</code> and <code>]]</code> with evil-mode)</li>
<li><code>C-c C-k</code> - Enter char-mode</li>
<li><code>C-c C-j</code> - Return to line-mode</li>
<li>If you have <code>evil-collection</code> installed, <code>term-mode</code> will enter char mode when you use Evil&rsquo;s Insert mode</li>
<li>Caveat - editing the input line with Evil motions doesn&rsquo;t work</li>
</ul>

<p>
NOTE: term-mode doesn&rsquo;t work on Windows: &ldquo;Spawning child process: invalid argument&rdquo;
</p>
</div>

<h3><a id="for-better-color-support" class="anchor" href="#for-better-color-support">¶</a>For better color support</h3><div class="outline-text-3" id="text-orgc6c2948">
<p>
Make sure the <code>tic</code> program is available on your machine (could be part of <code>ncurses</code> package).
</p>

<pre>(<span class="org-keyword">use-package</span> <span class="org-constant">eterm-256color</span>
  <span class="org-builtin">:hook</span> (term-mode . eterm-256color-mode))</pre>

<pre><span class="org-builtin">echo</span> <span class="org-string">"Hello System Crafters!"</span> | cowsay | lolcat -h 0.7</pre>
</div>

<h3><a id="ansi-term" class="anchor" href="#ansi-term">¶</a>ansi-term</h3><div class="outline-text-3" id="text-org5e4fffe">
<p>
<code>ansi-term</code> is a specialization of <code>term-mode.</code>
</p>

<p>
Minor differences:
</p>
<ul class="org-ul">
<li>C-x is prefix key instead of C-c</li>
<li>Buffers are managed slightly differently</li>
</ul>

<p>
Same caveats for Windows still apply.
</p>
</div>

<h2><a id="vterm-emacs-libvterm" class="anchor" href="#vterm-emacs-libvterm">¶</a>vterm (emacs-libvterm)</h2><div class="outline-text-2" id="text-org25ce7bb">
<p>
<a href="https://github.com/akermu/emacs-libvterm/">vterm</a> on GitHub
</p>

<p>
NOTE: This one needs to compile a native library, make sure to install its dependencies!
</p>

<p>
Differences to <code>term</code>:
</p>

<ul class="org-ul">
<li>Written in native code, much faster and better emulation</li>
<li>There is no <code>line-mode</code> / <code>char-mode</code> split</li>
</ul>

<pre>(<span class="org-keyword">use-package</span> <span class="org-constant">vterm</span>
  <span class="org-builtin">:commands</span> vterm
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> term-prompt-regexp <span class="org-string">"^[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">#$%&gt;\n]*[#$%&gt;] *"</span>)
  <span class="org-comment-delimiter">;;</span><span class="org-comment">(setq vterm-shell "zsh")</span>
  (<span class="org-keyword">setq</span> vterm-max-scrollback 10000))</pre>

<ul class="org-ul">
<li>Read docs on <code>vterm-use-vterm-prompt-detection-method</code> for prompt detection</li>
</ul>

<p>
<a href="https://github.com/akermu/emacs-libvterm/tree/01a1332ebb11daca5408f7fcb8a08454b0176e79#shell-side-configuration">vterm: Shell-side configuration</a>
</p>
</div>

<h2><a id="shell-mode" class="anchor" href="#shell-mode">¶</a>shell-mode</h2><div class="outline-text-2" id="text-org8d44de2">
<p>
Runs a shell program on your computer in a more controlled buffer.  Does not operate as a terminal emulator.
</p>

<ul class="org-ul">
<li><code>C-c C-p</code> / <code>C-c C-n</code> - go back and forward in the buffer&rsquo;s prompts</li>
<li><code>M-p</code> / <code>M-n</code> - go back and forward in the input history</li>
<li><code>C-c C-u</code> - delete the current input string backwards up to the cursor</li>
<li><code>counsel-shell-history</code> - A searchable history of commands typed into the shell</li>
</ul>

<p>
Pros/Cons
</p>

<p>
Better colors:
</p>

<p>
<a href="https://github.com/atomontage/xterm-color">xterm-color</a> on GitHub
</p>

<pre>(<span class="org-keyword">setq</span> comint-output-filter-functions
      (remove 'ansi-color-process-output comint-output-filter-functions))

(add-hook 'shell-mode-hook
          (<span class="org-keyword">lambda</span> ()
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Disable font-locking in this buffer to improve performance</span>
            (font-lock-mode -1)
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Prevent font-locking from being re-enabled in this buffer</span>
            (make-local-variable 'font-lock-function)
            (<span class="org-keyword">setq</span> font-lock-function (<span class="org-keyword">lambda</span> (_) nil))
            (add-hook 'comint-preoutput-filter-functions 'xterm-color-filter nil t)))</pre>

<p>
In Windows if you like PowerShell you can use this config:
</p>

<pre><span class="org-comment-delimiter">;; </span><span class="org-comment">Kudos to Jeffrey Snover: https://docs.microsoft.com/en-us/archive/blogs/dotnetinterop/run-powershell-as-a-shell-within-emacs</span>
(<span class="org-keyword">setq</span> explicit-shell-file-name <span class="org-string">"powershell.exe"</span>)
(<span class="org-keyword">setq</span> explicit-powershell.exe-args '())</pre>
</div>

<h2><a id="eshell" class="anchor" href="#eshell">¶</a>Eshell</h2><div class="outline-text-2" id="text-org5ec6a93">
<pre>(<span class="org-keyword">defun</span> <span class="org-function-name">efs/configure-eshell</span> ()
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Save command history when commands are entered</span>
  (add-hook 'eshell-pre-command-hook 'eshell-save-some-history)

  <span class="org-comment-delimiter">;; </span><span class="org-comment">Truncate buffer for performance</span>
  (add-to-list 'eshell-output-filter-functions 'eshell-truncate-buffer)

  <span class="org-comment-delimiter">;; </span><span class="org-comment">Bind some useful keys for evil-mode</span>
  (evil-define-key '(normal insert visual) eshell-mode-map (kbd <span class="org-string">"C-r"</span>) 'counsel-esh-history)
  (evil-define-key '(normal insert visual) eshell-mode-map (kbd <span class="org-string">"&lt;home&gt;"</span>) 'eshell-bol)
  (evil-normalize-keymaps)

  (<span class="org-keyword">setq</span> eshell-history-size         10000
        eshell-buffer-maximum-lines 10000
        eshell-hist-ignoredups t
        eshell-scroll-to-bottom-on-input t))

(<span class="org-keyword">use-package</span> <span class="org-constant">eshell</span>
  <span class="org-builtin">:hook</span> (eshell-first-time-mode . efs/configure-eshell))</pre>

<ul class="org-ul">
<li><code>counsel-eshell-history</code> - A searchable history of commands typed into the shell</li>
</ul>

<pre>(<span class="org-keyword">use-package</span> <span class="org-constant">eshell-git-prompt</span>)

<span class="org-builtin">:config</span>
(eshell-git-prompt-use-theme 'powerline))</pre>

<p>
Running programs in a term-mode buffer:
</p>

<pre>(<span class="org-keyword">with-eval-after-load</span> 'esh-opt
  (<span class="org-keyword">setq</span> eshell-destroy-buffer-when-process-dies t)
  (<span class="org-keyword">setq</span> eshell-visual-commands '(<span class="org-string">"htop"</span> <span class="org-string">"zsh"</span> <span class="org-string">"vim"</span>)))</pre>

<p>
Pros:
</p>

<ul class="org-ul">
<li>Replicates Bash with cross-platform elisp functions</li>
<li>Consistent shell experience across all OSes</li>
<li>You can run Emacs commands and arbitrary Emacs Lisp in the shell</li>
<li>You can pipe output of commands directly into an Emacs buffer</li>
<li>Supports TRAMP!</li>
</ul>

<p>
Cons:
</p>

<ul class="org-ul">
<li>Completions are not great out of the box compared to Bash</li>
<li>Eshell commands can be very slow compared to the real programs</li>
<li>Piping is much less functional than in &ldquo;real&rdquo; shells</li>
<li>Subshell syntax is a bit different - <code>${}</code> instead of <code>$()</code></li>
<li>Programs that read input (like language REPLs) can operate strangely</li>
<li>Tools that depend on setting shell environment (<code>nvm</code>, <code>virtualenv</code>, etc) don&rsquo;t work</li>
<li>Can be a little slow on Windows</li>
</ul>

<p>
Interesting articles:
</p>
<ul class="org-ul">
<li><a href="https://ambrevar.xyz/emacs-eshell/index.html">Ambrevar&rsquo;s article on eshell</a></li>
<li><a href="https://ambrevar.xyz/emacs-eshell-versus-shell/index.html">Ambrevar&rsquo;s article on eshell vs shell</a></li>
</ul>
</div>

<h2><a id="recommendations" class="anchor" href="#recommendations">¶</a>Recommendations</h2><div class="outline-text-2" id="text-orge22dd4e">
<ul class="org-ul">
<li>Use <code>term</code> or <code>ansi-term</code> if you&rsquo;re on Linux / macOS and don&rsquo;t care as much about output speed</li>
<li>Use <code>vterm</code> if you&rsquo;re on Linux / macOS and want faster output and better terminal emulation</li>
<li>Use <code>shell</code> on Windows if you want to use PowerShell, Bash, or WSL</li>
<li>Use <code>eshell</code> on any OS if you want a consistent shell experience everywhere with Lisp superpowers full Emacs integration</li>
</ul>
</div>
</div></div><div class="list-form center"><div class="list-form-title">Subscribe to the System Crafters Newsletter!</div><form method="POST" action="https://www.simplelists.com/subscribe.php"><input type="hidden" name="format" value="text"/><input type="hidden" name="action" value="subscribe"/><input type="hidden" name="list" value="news@lists.systemcrafters.net"/><div class="list-form-message">Stay up to date with the latest System Crafters news and updates!  Read the <a href="/newsletter/">Newsletter</a> page for more information.</div><div class="row"><div class="column"><div class="row center list-form-label">Name (optional)</div><div class="row"><input type="text" name="name"/></div></div><div class="column"><div class="row center list-form-label">Email Address</div><div class="row"><input type="text" name="email"/></div></div></div><div><input type="submit" value="Subscribe!"/></div></form></div></div><footer class="site-footer"><div class="container"><div class="row"><div class="column"><p><a href="https://weavermarquez.github.io/privacy-policy/">Privacy Policy</a> · <a href="https://weavermarquez.github.io/credits/">Credits</a> · <a href="https://weavermarquez.github.io/rss/">RSS Feeds</a> · <a rel="me" href="https://fosstodon.org/@daviwil">Fediverse</a></p><p>© 2021-2023 System Crafters LLC, and also Weaver Ripped this off</p></div><div class="column align-right"><p><a href="https://github.com/weavermarquez/weavermarquez.github.io"><img src="https://weavermarquez.github.io/img/codeberg.png" style="width: 120px" alt="Contribute on Codeberg"/></a></p></div></div></div></footer></body></html>
