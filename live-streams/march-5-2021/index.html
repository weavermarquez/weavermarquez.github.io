<!-- Generated from 310d701 on 2023-12-19 @ 09:37 with Emacs 27.2 (Org mode 9.4.4) -->
<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta author="System Crafters - David Wilson"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="icon" type="image/png" href="/img/favicon.png"/><link rel="alternative" type="application/rss+xml" title="System Crafters News" href="https://weavermarquez.github.io/rss/news.xml"/><link rel="stylesheet" href="https://weavermarquez.github.io/fonts/iosevka-aile/iosevka-aile.css"/><link rel="stylesheet" href="https://weavermarquez.github.io/fonts/jetbrains-mono/jetbrains-mono.css"/><link rel="stylesheet" href="https://weavermarquez.github.io/css/code.css"/><link rel="stylesheet" href="https://weavermarquez.github.io/css/site.css"/><script defer="defer" data-domain="weavermarquez.github.io" src="https://plausible.io/js/plausible.js"></script><title>Emacs Native Comp is going to change everything - System Crafters</title></head><body><header class="site-header"><div class="container"><div class="site-title"><img class="logo" src="https://weavermarquez.github.io/img/sc_logo.png" alt="System Crafters"/></div></div><div class="site-masthead"><div class="container"><nav class="nav"><a class="nav-link" href="/">Home</a> <a class="nav-link" href="/guides/">Guides</a> <a class="nav-link" href="/news/">News</a> <a class="nav-link" href="/community/">Community</a> <a class="nav-link" href="/">Home (2)</a> <a class="nav-link" href="/how-to-help/">How to Help</a></nav></div></div></header><div class="container"><div class="site-post"><h1 class="site-post-title">Emacs Native Comp is going to change everything</h1><p class="site-post-meta">March  5, 2021</p><div class="video">  <iframe src="https://www.youtube.com/embed/i8OLg-f9EHk" allowfullscreen></iframe></div><div id="content">
<h2><a id="emacs-native-comp-is-going-to-change-beverythingb" class="anchor" href="#emacs-native-comp-is-going-to-change-beverythingb">¶</a>Emacs Native Comp is going to change <b>everything</b></h2><h3><a id="what-is-it" class="anchor" href="#what-is-it">¶</a>What is it?</h3><div class="outline-text-3" id="text-orgb4d09c4">
<p>
This is a new development in Emacs where Emacs Lisp code can now be compiled directly to native machine code for pretty major performance and responsiveness gains.
</p>

<p>
It uses a library called <code>libgccjit</code> to use the compiler mechanics of GCC (GNU Compiler Collection) to translate Emacs Lisp to machine code on demand.
</p>
</div>

<h3><a id="how-do-i-get-it" class="anchor" href="#how-do-i-get-it">¶</a>How do I get it?</h3><div class="outline-text-3" id="text-orgec64219">
<p>
If you clone the Emacs repository from Savannah, you can check out the <code>feature/native-comp</code> branch:
</p>

<pre>git clone https://git.savannah.gnu.org/git/emacs.git -b feature/native-comp</pre>

<p>
You can then follow the Emacs build instructions in the file <code>INSTALL</code> to build Emacs correctly for your system.  The only changes to those instructions would be to add the <code>--with-native-compilation</code> compiler parameter and use <code>NATIVE_FULL_AOT=1</code> when running <code>make</code> so that all of Emacs&rsquo; bundled Emacs Lisp gets compiled to native during the build process.
</p>

<p>
We&rsquo;re not going to build it today because it takes a while :)
</p>

<p>
If you&rsquo;re using macOS: <a href="https://github.com/d12frosted/homebrew-emacs-plus">https://github.com/d12frosted/homebrew-emacs-plus</a>
</p>

<p>
If you&rsquo;re on Windows, this Reddit post can be helpful:
</p>

<p>
<a href="https://www.reddit.com/r/emacs/comments/lxabxs/outline_of_how_to_compile_emacs28_with_nativecomp/">https://www.reddit.com/r/emacs/comments/lxabxs/outline_of_how_to_compile_emacs28_with_nativecomp/</a>
</p>
</div>

<h3><a id="if-yoursquore-using-guixx2026" class="anchor" href="#if-yoursquore-using-guixx2026">¶</a>If you&rsquo;re using Guix&#x2026;</h3><div class="outline-text-3" id="text-org62699ad">
<p>
Use the <code>flat</code> repository!  There is an <code>emacs-native-comp</code> package there that will take care of everything for you.
</p>

<p>
<a href="https://github.com/flatwhatson/guix-channel">https://github.com/flatwhatson/guix-channel</a>
</p>

<pre>(cons* (channel
        (name 'flat)
        (url <span class="org-string">"https://github.com/flatwhatson/guix-channel.git"</span>)
        <span class="org-comment-delimiter">;; </span><span class="org-comment">(commit</span>
        <span class="org-comment-delimiter">;;  </span><span class="org-comment">"302f8a4f7e56cb3b484de9fe86617a3aaf20098c")</span>
        (introduction
         (make-channel-introduction
          <span class="org-string">"33f86a4b48205c0dc19d7c036c85393f0766f806"</span>
          (openpgp-fingerprint
           <span class="org-string">"736A C00E 1254 378B A982  7AF6 9DBE 8265 81B6 4490"</span>))))
       %default-channels)</pre>
</div>

<h3><a id="benchmarks" class="anchor" href="#benchmarks">¶</a>Benchmarks</h3><div class="outline-text-3" id="text-orgbd72384">
<p>
Some benchmarking steps: <a href="https://github.com/shshkn/emacs.d/blob/master/docs/nativecomp.md">https://github.com/shshkn/emacs.d/blob/master/docs/nativecomp.md</a> (thanks elken!)
</p>

<p>
<a href="https://www.emacswiki.org/emacs/EmacsLispBenchmark">https://www.emacswiki.org/emacs/EmacsLispBenchmark</a>
</p>

<pre><span class="org-comment-delimiter">;; </span><span class="org-comment">Interpreted Emacs Lisp</span>
(<span class="org-keyword">benchmark-run</span> 1000
  (<span class="org-keyword">let*</span> ((list (mapcar 'random (make-list 100 most-positive-fixnum)))
        (i (length list)))
    (<span class="org-keyword">while</span> (&gt; i 1)
      (<span class="org-keyword">let</span> ((b list))
        (<span class="org-keyword">while</span> (cdr b)
          (<span class="org-keyword">when</span> (&lt; (cadr b) (car b))
            (setcar b (<span class="org-keyword">prog1</span> (cadr b)
                        (setcdr b (cons (car b) (cddr b))))))
          (<span class="org-keyword">setq</span> b (cdr b))))
      (<span class="org-keyword">setq</span> i (1- i)))
    list))

<span class="org-comment-delimiter">;; </span><span class="org-comment">Byte compilation</span>
(<span class="org-keyword">benchmark-run-compiled</span> 3000
  (<span class="org-keyword">let*</span> ((list (mapcar 'random (make-list 100 most-positive-fixnum)))
        (i (length list)))
    (<span class="org-keyword">while</span> (&gt; i 1)
      (<span class="org-keyword">let</span> ((b list))
        (<span class="org-keyword">while</span> (cdr b)
          (<span class="org-keyword">when</span> (&lt; (cadr b) (car b))
            (setcar b (<span class="org-keyword">prog1</span> (cadr b)
                        (setcdr b (cons (car b) (cddr b))))))
          (<span class="org-keyword">setq</span> b (cdr b))))
      (<span class="org-keyword">setq</span> i (1- i)))
    list))

(<span class="org-keyword">setq</span> dw/compiled-benchmark
  (native-compile
    (<span class="org-keyword">lambda</span> ()
      (<span class="org-keyword">let*</span> ((list (mapcar 'random (make-list 100 most-positive-fixnum)))
            (i (length list)))
        (<span class="org-keyword">while</span> (&gt; i 1)
          (<span class="org-keyword">let</span> ((b list))
            (<span class="org-keyword">while</span> (cdr b)
              (<span class="org-keyword">when</span> (&lt; (cadr b) (car b))
                (setcar b (<span class="org-keyword">prog1</span> (cadr b)
                            (setcdr b (cons (car b) (cddr b))))))
              (<span class="org-keyword">setq</span> b (cdr b))))
          (<span class="org-keyword">setq</span> i (1- i)))
        list))))

<span class="org-comment-delimiter">;; </span><span class="org-comment">Native compilation</span>
(<span class="org-keyword">setq</span> comp-speed 2)
(<span class="org-keyword">benchmark-run-compiled</span> 3000
  (funcall dw/compiled-benchmark))</pre>
</div>

<h3><a id="when-is-it-coming" class="anchor" href="#when-is-it-coming">¶</a>When is it coming?</h3><div class="outline-text-3" id="text-orgc485754">
<p>
A tweet from the native-comp creator, Andrea Corallo, yesterday:
</p>

<p>
<a href="https://twitter.com/Koral_001/status/1367571866437754882">https://twitter.com/Koral_001/status/1367571866437754882</a>
</p>

<p>
&ldquo;Eli (#emacs maintainer) is working on #gccemacs #native-comp with the goal of having it merged.&rdquo;
</p>

<p>
It appears that this branch is being prepared to merge into <code>master</code> for Emacs 28.1!  The feature won&rsquo;t be turned on by default in Emacs yet, though.
</p>

<p>
The <code>NEWS</code> file in the <code>feature/native-comp</code> branch has been updated to mention a finalized compilation flag <code>--with-native-compilation</code> (hat tip to &rsquo;undecided&rsquo; in the Discord!)
</p>

<p>
<a href="https://github.com/emacs-mirror/emacs/commit/4f90b0b6e6249597cf2e1450b5b9d7f6522c049f">https://github.com/emacs-mirror/emacs/commit/4f90b0b6e6249597cf2e1450b5b9d7f6522c049f</a>
</p>
</div>

<h3><a id="silencing-the-warnings" class="anchor" href="#silencing-the-warnings">¶</a>Silencing the warnings!</h3><div class="outline-text-3" id="text-orgce8c5de">
<pre>(<span class="org-keyword">setq</span> comp-async-report-warnings-errors nil)</pre>
</div>

<h2><a id="trying-out-eglot-an-alternative-to-lsp-mode" class="anchor" href="#trying-out-eglot-an-alternative-to-lsp-mode">¶</a>Trying out Eglot, an alternative to lsp-mode</h2><div class="outline-text-2" id="text-org4aa285d">
<p>
Eglot is another client for the Language Server Protocol in Emacs.
</p>

<p>
The main difference between it and <code>lsp-mode</code> is that Eglot attempts to use as much Emacs-native integration as possible without introducing new user interface concepts.
</p>

<p>
How does it work? <a href="https://github.com/joaotavora/eglot#how-does-eglot-work">https://github.com/joaotavora/eglot#how-does-eglot-work</a>
</p>
</div>

<h3><a id="setting-it-up" class="anchor" href="#setting-it-up">¶</a>Setting it up</h3><div class="outline-text-3" id="text-orgf7c1cf2">
<p>
Make sure to disable all <code>lsp-mode</code> hooks first!
</p>

<pre>(<span class="org-keyword">use-package</span> <span class="org-constant">eglot</span>)</pre>
</div>

<h2><a id="community-chat---qampa" class="anchor" href="#community-chat---qampa">¶</a>Community Chat - Q&amp;A</h2>
</div></div><div class="list-form center"><div class="list-form-title">Subscribe to the System Crafters Newsletter!</div><form method="POST" action="https://www.simplelists.com/subscribe.php"><input type="hidden" name="format" value="text"/><input type="hidden" name="action" value="subscribe"/><input type="hidden" name="list" value="news@lists.systemcrafters.net"/><div class="list-form-message">Stay up to date with the latest System Crafters news and updates!  Read the <a href="/newsletter/">Newsletter</a> page for more information.</div><div class="row"><div class="column"><div class="row center list-form-label">Name (optional)</div><div class="row"><input type="text" name="name"/></div></div><div class="column"><div class="row center list-form-label">Email Address</div><div class="row"><input type="text" name="email"/></div></div></div><div><input type="submit" value="Subscribe!"/></div></form></div></div><footer class="site-footer"><div class="container"><div class="row"><div class="column"><p><a href="https://weavermarquez.github.io/privacy-policy/">Privacy Policy</a> · <a href="https://weavermarquez.github.io/credits/">Credits</a> · <a href="https://weavermarquez.github.io/rss/">RSS Feeds</a> · <a rel="me" href="https://fosstodon.org/@daviwil">Fediverse</a></p><p>© 2021-2023 System Crafters LLC, and also Weaver Ripped this off</p></div><div class="column align-right"><p><a href="https://github.com/weavermarquez/weavermarquez.github.io"><img src="https://weavermarquez.github.io/img/codeberg.png" style="width: 120px" alt="Contribute on Codeberg"/></a></p></div></div></div></footer></body></html>
