<!-- Generated from 310d701 on 2023-12-19 @ 09:37 with Emacs 27.2 (Org mode 9.4.4) -->
<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta author="System Crafters - David Wilson"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="icon" type="image/png" href="/img/favicon.png"/><link rel="alternative" type="application/rss+xml" title="System Crafters News" href="https://weavermarquez.github.io/rss/news.xml"/><link rel="stylesheet" href="https://weavermarquez.github.io/fonts/iosevka-aile/iosevka-aile.css"/><link rel="stylesheet" href="https://weavermarquez.github.io/fonts/jetbrains-mono/jetbrains-mono.css"/><link rel="stylesheet" href="https://weavermarquez.github.io/css/code.css"/><link rel="stylesheet" href="https://weavermarquez.github.io/css/site.css"/><script defer="defer" data-domain="weavermarquez.github.io" src="https://plausible.io/js/plausible.js"></script><title>Hosting Services with Guix Containers - System Crafters</title></head><body><header class="site-header"><div class="container"><div class="site-title"><img class="logo" src="https://weavermarquez.github.io/img/sc_logo.png" alt="System Crafters"/></div></div><div class="site-masthead"><div class="container"><nav class="nav"><a class="nav-link" href="/">Home</a> <a class="nav-link" href="/guides/">Guides</a> <a class="nav-link" href="/news/">News</a> <a class="nav-link" href="/community/">Community</a> <a class="nav-link" href="/">Home (2)</a> <a class="nav-link" href="/how-to-help/">How to Help</a></nav></div></div></header><div class="container"><div class="site-post"><h1 class="site-post-title">Hosting Services with Guix Containers</h1><p class="site-post-meta">November 10, 2023</p><div class="video">  <iframe src="https://www.youtube.com/embed/QS5MnN_fits" allowfullscreen></iframe></div><div id="content">
<h2><a id="updates" class="anchor" href="#updates">¶</a>Updates</h2><div class="outline-text-2" id="text-org68b7123">
<ul class="org-ul">
<li><p>
Another experiment!  The primary live chat is now on IRC: <code>#systemcrafters-live</code> on <code>irc.libera-chat</code>!
</p>

<p>
Check out the new Live page: <a href="https://systemcrafters.net/live">https://systemcrafters.net/live</a>
</p></li>

<li>The new IRC bridge and chat overlay is powered by Guile Scheme!
<a href="https://codeberg.org/SystemCrafters/live-crafter/src/branch/master/chat.scm">https://codeberg.org/SystemCrafters/live-crafter/src/branch/master/chat.scm</a></li>

<li>Still working on the Matrix to IRC bridge problem.  Today&rsquo;s stream is one side-effect of my investigations!</li>
</ul>
</div>

<h2><a id="making-guix-hosting-easier" class="anchor" href="#making-guix-hosting-easier">¶</a>Making Guix Hosting Easier</h2><div class="outline-text-2" id="text-org9bb8d0c">
<p>
One big challenge of using Guix to deploy servers to the cloud is that most cloud providers do not provide Guix images so you either have to upload your own or convert another distro to Guix!
</p>

<p>
Recently it occurred to me, though, that it might be possible to use Guix inside of a common &ldquo;foreign&rdquo; distro on a cloud provider.  Both Debian and Alpine have Guix in their package repos, so we&rsquo;ll experiment with one of these distros to see how feasible this idea will be!
</p>

<p>
There is prior art for hosting services in Guix containers.  <a href="https://fosstodon.org/@pjotrprins@mastodon.social">Pjotr Prins</a> shared this configuration with me:
</p>

<p>
<a href="https://git.genenetwork.org/guix-bioinformatics/tree/gn/services/bnw-container.scm">https://git.genenetwork.org/guix-bioinformatics/tree/gn/services/bnw-container.scm</a>
</p>

<p>
Let&rsquo;s try to host a few things inside of a Guix container (or containers?)
</p>

<ul class="org-ul">
<li>Basic website with Nginx</li>
<li>XMPP server with Prosody</li>
<li>IRC bouncer with ZNC?</li>
<li>SSH server?</li>
</ul>
</div>


<h3><a id="the-final-config" class="anchor" href="#the-final-config">¶</a>The final config</h3><div class="outline-text-3" id="text-org462635a">
<pre>(use-modules (gnu)
             (guix gexp))

(use-package-modules bash messaging)
(use-service-modules messaging networking ssh web)

(operating-system
  (host-name <span class="org-string">"crafter-host"</span>)
  (timezone <span class="org-string">"Etc/UTC"</span>)
  (locale <span class="org-string">"en_US.utf8"</span>)

  (bootloader (bootloader-configuration
               (bootloader grub-bootloader)
               (targets '(<span class="org-string">"does-not-matter"</span>))))

  (file-systems %base-file-systems)

  <span class="org-comment-delimiter">;; </span><span class="org-comment">No firmware for containers.</span>
  (firmware '())

  (users
   (list (user-account
          (name <span class="org-string">"crafter"</span>)
          (group <span class="org-string">"users"</span>)
          (password (crypt <span class="org-string">"InitialPassword!"</span> <span class="org-string">"crafter"</span>)))))

  <span class="org-comment-delimiter">;; </span><span class="org-comment">We don't need any packages inside the container.</span>
  (packages (list coreutils bash prosody))

  <span class="org-comment-delimiter">;; </span><span class="org-comment">Basic services</span>
  (services (list (service dhcp-client-service-type)

                  <span class="org-comment-delimiter">;; </span><span class="org-comment">Copy our web server files into the container</span>
                  (service special-files-service-type
                           `((<span class="org-string">"/srv/http/systemcrafters.net"</span> ,(local-file <span class="org-string">"website"</span>
                                                                          <span class="org-string">"site-files"</span>
                                                                          <span class="org-builtin">#:recursive?</span> #t))))

                  (service nginx-service-type
                           (nginx-configuration
                            (server-blocks
                             (list (nginx-server-configuration
                                    (listen '(<span class="org-string">"*:8000"</span>))
                                    (server-name '(<span class="org-string">"systemcrafters.net"</span>))
                                    (root <span class="org-string">"/srv/http/systemcrafters.net"</span>))))))

                  (service openssh-service-type
                           (openssh-configuration
                            (port-number 2222)
                            (permit-root-login #t)))

                  (service syslog-service-type)

                  (service prosody-service-type
                           (prosody-configuration
                            (modules-enabled (cons* <span class="org-string">"groups"</span> <span class="org-string">"mam"</span> %default-modules-enabled))
                            (int-components
                             (list
                              (int-component-configuration
                               (hostname <span class="org-string">"muc.localhost"</span>)
                               (plugin <span class="org-string">"muc"</span>)
                               (mod-muc (mod-muc-configuration)))))
                            (virtualhosts
                             (list
                              (virtualhost-configuration
                               (domain <span class="org-string">"localhost"</span>)))))))))</pre>

<p>
I was running it with the following command:
</p>

<pre>sudo $(guix system container --network container-config.scm)</pre>
</div>

<h2><a id="guix-containers-vs-docker-compose" class="anchor" href="#guix-containers-vs-docker-compose">¶</a>Guix Containers vs Docker Compose</h2>
</div></div><div class="list-form center"><div class="list-form-title">Subscribe to the System Crafters Newsletter!</div><form method="POST" action="https://www.simplelists.com/subscribe.php"><input type="hidden" name="format" value="text"/><input type="hidden" name="action" value="subscribe"/><input type="hidden" name="list" value="news@lists.systemcrafters.net"/><div class="list-form-message">Stay up to date with the latest System Crafters news and updates!  Read the <a href="/newsletter/">Newsletter</a> page for more information.</div><div class="row"><div class="column"><div class="row center list-form-label">Name (optional)</div><div class="row"><input type="text" name="name"/></div></div><div class="column"><div class="row center list-form-label">Email Address</div><div class="row"><input type="text" name="email"/></div></div></div><div><input type="submit" value="Subscribe!"/></div></form></div></div><footer class="site-footer"><div class="container"><div class="row"><div class="column"><p><a href="https://weavermarquez.github.io/privacy-policy/">Privacy Policy</a> · <a href="https://weavermarquez.github.io/credits/">Credits</a> · <a href="https://weavermarquez.github.io/rss/">RSS Feeds</a> · <a rel="me" href="https://fosstodon.org/@daviwil">Fediverse</a></p><p>© 2021-2023 System Crafters LLC, and also Weaver Ripped this off</p></div><div class="column align-right"><p><a href="https://github.com/weavermarquez/weavermarquez.github.io"><img src="https://weavermarquez.github.io/img/codeberg.png" style="width: 120px" alt="Contribute on Codeberg"/></a></p></div></div></div></footer></body></html>
